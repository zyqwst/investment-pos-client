webpackJsonp([15],{"D+2E":function(e,t){},g5nM:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=a("Xxa5"),s=a.n(n),r=a("exGp"),l=a.n(r),o=a("Dd8w"),c=a.n(o),i=a("7L0k"),u=a("yKLP"),d=a("jYxq");var f=a("VvTn"),m=a("YN6D"),p=a("FB77"),h=a("NYxO"),b={data:function(){return{loading:!1,sale:{},dtls:[],selectDtls:[],showAmountDialog:!1,cash:0,card:0,pos:0,amount:0,commitDisabled:!1,input:null}},components:{Calculator:m.a,CashType:p.a},deactivated:function(){this.$destroy()},computed:c()({},Object(h.b)(["member","isVip","curSaleMan"]),{priceIcon:function(){var e={1:"gift",2:"cu-price",3:"vip-price",4:"retail-price"};return function(t){return e[t]}}}),watch:{selectDtls:{handler:function(e,t){var a=this.selectDtls.map(function(e){return Object(f.b)(e.refunding,e.price)}).reduce(function(e,t){return Object(f.a)(e,t)},0);this.amount=a},deep:!0}},activated:function(){this.fetchSale(this.$route.params.saleId)},methods:{selectable:function(e,t){return e.amount>0&&Object(f.c)(e.qty,e.refundQty)>0},cardChange:function(e){this.card=e},cashChange:function(e){this.cash=e},posChange:function(e){this.pos=e},focus:function(e){this.input=e},back:function(){var e=this;this.$store.dispatch("removeMember").then(function(){return e.$router.back()})},handleSelectionChange:function(e){this.selectDtls=e},fetchSale:function(e){var t=this;return l()(s.a.mark(function a(){var n,r,l;return s.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,t.loading=!0,a.next=4,Object(i.h)(e);case 4:if(n=a.sent,t.sale=n.object.order,(r=n.object.list).forEach(function(e){return e.refunding=Object(f.c)(e.qty,e.refundQty)}),t.dtls=r,!t.sale.memberId){a.next=14;break}return a.next=12,Object(u.c)(t.sale.memberId);case 12:l=a.sent,t.$store.dispatch("setMember",l.object);case 14:return a.prev=14,t.loading=!1,a.finish(14);case 17:case"end":return a.stop()}},a,t,[[0,,14,17]])}))()},refund:function(){var e=this;return l()(s.a.mark(function t(){var a;return s.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=!0,e.selectDtls.forEach(function(t){t.refunding>Object(f.c)(t.qty,t.refundQty)&&(a=!1,e.$message({message:"【"+t.name+"】退货数量超过可退货数量",type:"warning"})),0!=t.refunding&&NaN!=Number(t.refunding)||(a=!1,e.$message({message:"【"+t.name+"】退货数量不可为0",type:"warning"}))}),a){t.next=4;break}return t.abrupt("return");case 4:e.showAmountDialog=!0;case 5:case"end":return t.stop()}},t,e)}))()},confirm:function(){var e=this;return l()(s.a.mark(function t(){var a;return s.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(Object(f.a)(Object(f.a)(e.pos,e.card),e.cash)==e.amount){t.next=3;break}return e.$message({message:"退款金额必须等于总额",type:"warning"}),t.abrupt("return");case 3:return(a={cashAmount:e.cash,cardAmount:e.card,posAmount:e.pos,id:e.sale.id,salemanId:e.curSaleMan.id}).list=e.selectDtls.map(function(e){return{id:e.id,refund:Number(e.refunding)}}),t.prev=5,e.commitDisabled=!0,t.next=9,n=a,d.a.post("/refund",n);case 9:t.sent,e.$message("提交成功"),e.showAmountDialog=!1,e.fetchSale(e.sale.id);case 13:return t.prev=13,e.commitDisabled=!1,t.finish(13);case 16:case"end":return t.stop()}var n},t,e,[[5,,13,16]])}))()}}},v={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"refund"},[a("navbar",{on:{back:e.back}},[a("div",{staticClass:"title"},[e._v("销售退货")])]),e._v(" "),a("div",{staticClass:"container"},[a("el-row",[a("el-col",{attrs:{span:9,offset:2}},[a("el-form",{staticClass:"refund-sale",attrs:{"label-width":"80px"}},[a("el-form-item",{attrs:{label:"订单号:"}},[e._v("\n                        "+e._s(e.sale.billno)+"\n                    ")]),e._v(" "),a("el-form-item",{attrs:{label:"销售日期:"}},[e._v("\n                        "+e._s(e.sale.creDate)+"\n                    ")]),e._v(" "),a("el-form-item",{attrs:{label:"收银员:"}},[e._v("\n                        ("+e._s(e.sale.saleManCode)+") "+e._s(e.sale.saleManName)+"\n                    ")])],1)],1),e._v(" "),a("el-col",{attrs:{span:7,offset:2}},[a("el-form",{staticClass:"refund-sale",attrs:{"label-width":"80px"}},[a("el-form-item",{attrs:{label:"金额:"}},[e._v("\n                        "+e._s(e._f("RMB")(e.sale.amount))+"\n                    ")]),e._v(" "),a("el-form-item",{attrs:{label:"会员:"}},[e._v("\n                        "+e._s(e.sale.memberName)+"\n                    ")]),e._v(" "),a("el-form-item",{attrs:{label:"退款金额:"}},[a("div",{staticStyle:{"font-size":"1.4rem",color:"red"}},[e._v(e._s(e._f("RMB")(e.amount)))])])],1)],1),e._v(" "),a("el-col",{attrs:{span:2}},[a("div",{staticStyle:{height:"120px",display:"flex","flex-direction":"column-reverse"}},[a("el-button",{attrs:{type:"primary",disabled:0==e.selectDtls.length},nativeOn:{click:function(t){return t.preventDefault(),e.refund(t)}}},[e._v("退 款")])],1)])],1),e._v(" "),a("el-row",[a("el-col",{attrs:{span:22,offset:1}},[a("el-table",{attrs:{data:e.dtls,stripe:"","highlight-current-row":""},on:{"selection-change":e.handleSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"55",selectable:e.selectable}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"商品"}}),e._v(" "),a("el-table-column",{attrs:{align:"left",label:"单价"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("div",[a("svg-icon",{staticClass:"retail-price",attrs:{"icon-class":e.priceIcon(t.row.type)}}),e._v(e._s(t.row.price))],1)]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"qty",label:"销售数量"}}),e._v(" "),a("el-table-column",{attrs:{prop:"amount",label:"销售金额"}}),e._v(" "),a("el-table-column",{attrs:{prop:"refundQty",label:"已退数量"}}),e._v(" "),a("el-table-column",{attrs:{label:"退货数量"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("sy-input",{attrs:{disabled:t.row.qty==t.row.refundQty||0==t.row.amount,placement:"left"},model:{value:t.row.refunding,callback:function(a){e.$set(t.row,"refunding",a)},expression:"scope.row.refunding"}})]}}])})],1)],1)],1)],1),e._v(" "),e.showAmountDialog?a("el-dialog",{attrs:{"custom-class":"refund-amount-dialog","append-to-body":!0,visible:e.showAmountDialog,fullscreen:"","show-close":!1},on:{"update:visible":function(t){e.showAmountDialog=t}}},[a("navbar",{attrs:{slot:"title"},on:{back:function(t){e.showAmountDialog=!1}},slot:"title"},[a("div",{staticClass:"title"},[e._v("退款")])]),e._v(" "),a("div",{staticClass:"container"},[a("cash-type",{attrs:{amount:e.amount,showChange:!1,showCard:e.isVip},on:{focus:e.focus,cashChange:e.cashChange,posChange:e.posChange,cardChange:e.cardChange}}),e._v(" "),a("calculator",{staticClass:"calc",attrs:{input:e.input,loading:e.commitDisabled},on:{enter:e.confirm}})],1)],1):e._e()],1)},staticRenderFns:[]};var g=a("VU/8")(b,v,!1,function(e){a("D+2E")},null,null);t.default=g.exports}});